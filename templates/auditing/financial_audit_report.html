{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Financial Audit Report{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Professional Header -->
    <div class="bg-gradient-to-r from-slate-800 to-slate-900 shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="mb-6 lg:mb-0">
                    <h1 class="text-3xl font-bold text-white">Financial Audit Report</h1>
                    <p class="mt-2 text-gray-300">Comprehensive financial analysis and compliance monitoring</p>
                    <div class="mt-4 text-sm text-gray-400">
                        {% if month_name %}
                        Period: {{ month_name }} {{ year }}
                        {% else %}
                        Period: {{ year }}
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="window.print()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-700 hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        <span class="material-icons-outlined mr-2">print</span>
                        Print Report
                    </button>
                    <button onclick="exportToExcel()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                        <span class="material-icons-outlined mr-2">download</span>
                        Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Advanced Filters -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 mb-8">
            <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <span class="material-icons-outlined mr-3 text-indigo-600">filter_alt</span>
                            Report Filters
                        </h2>
                        <p class="mt-1 text-sm text-gray-600">Customize your audit report parameters</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                        <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            {% for y in available_years %}
                            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                        <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Full Year</option>
                            {% for month_num, month_name in months %}
                            <option value="{{ month_num }}" {% if month_num == month %}selected{% endif %}>{{ month_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Area</label>
                        <select id="areaFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Areas</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}" {% if area.id == selected_area %}selected{% endif %}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">District</label>
                        <select id="districtFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Districts</option>
                            {% for district in districts %}
                            <option value="{{ district.id }}" {% if district.id == selected_district %}selected{% endif %}">{{ district.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Branch</label>
                        <select id="branchFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}" {% if branch.id == selected_branch %}selected{% endif %}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button onclick="applyFilters()" 
                                class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors font-medium shadow-md">
                            <span class="material-icons-outlined mr-2 align-middle">search</span>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-green-600 text-xl">savings</span>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">{{ grand_totals.contributions|floatformat:0|intcomma }}</h3>
                    <p class="text-sm text-gray-600 mt-1">Total Contributions</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Mission Allocation</span>
                            <span class="font-semibold text-green-600">{{ grand_totals.mission_allocation|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span class="text-gray-600">Branch Retained</span>
                            <span class="font-semibold text-blue-600">{{ grand_totals.branch_retained|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-100 to-red-200 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-red-600 text-xl">account_balance</span>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">{{ grand_totals.expenditures|floatformat:0|intcomma }}</h3>
                    <p class="text-sm text-gray-600 mt-1">Total Expenditures</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Payroll</span>
                            <span class="font-semibold text-purple-600">{{ grand_totals.payroll|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span class="text-gray-600">Other Expenses</span>
                            <span class="font-semibold text-orange-600">{{ grand_totals.expenditures|sub:grand_totals.payroll|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-blue-600 text-xl">swap_horiz</span>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">{{ grand_totals.remittances_sent|floatformat:0|intcomma }}</h3>
                    <p class="text-sm text-gray-600 mt-1">Remittances Sent</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Amount Due</span>
                            <span class="font-semibold text-yellow-600">{{ grand_totals.remittances_due|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span class="text-gray-600">Outstanding</span>
                            <span class="font-semibold text-red-600">{{ grand_totals.remittances_due|sub:grand_totals.remittances_sent|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-100 to-indigo-200 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-indigo-600 text-xl">balance</span>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">{{ grand_totals.net_balance|floatformat:0|intcomma }}</h3>
                    <p class="text-sm text-gray-600 mt-1">Net Balance</p>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if grand_totals.net_balance >= 0 %}bg-green-100 text-green-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {% if grand_totals.net_balance >= 0 %}Healthy{% else %}Deficit{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Financial Breakdown Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Branch Financial Breakdown</h2>
                        <p class="mt-1 text-sm text-gray-600">Detailed financial analysis by branch</p>
                    </div>
                    <div class="text-sm text-gray-600">
                        {{ branch_data|length }} branches analyzed
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">District</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Contributions</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Mission Alloc</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Branch Retained</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Expenditures</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Payroll</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net Balance</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Compliance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for data in branch_data %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ data.branch.name }}</div>
                                <div class="text-xs text-gray-500">{{ data.branch.code }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ data.branch.district.name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-semibold">
                                {{ data.contributions|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                {{ data.mission_allocation|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                {{ data.branch_retained|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                {{ data.expenditures|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">
                                {{ data.payroll|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold
                                {% if data.net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ data.net_balance|floatformat:0|intcomma }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if data.compliance == 'Good' %}bg-green-100 text-green-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ data.compliance }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <a href="{% url 'core:branch_financial_details' data.branch.id %}" 
                                   class="text-indigo-600 hover:text-indigo-900 font-medium">
                                    View Details
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="px-6 py-16 text-center">
                                <div class="flex flex-col items-center">
                                    <span class="material-icons-outlined text-6xl text-gray-300 mb-4">account_balance</span>
                                    <p class="text-xl font-semibold text-gray-700">No financial data found</p>
                                    <p class="text-sm text-gray-500 mt-2">Try adjusting your filters or select a different period</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Grand Total Row -->
                        {% if branch_data %}
                        <tr class="bg-gray-50 font-semibold">
                            <td colspan="2" class="px-6 py-4 text-sm text-gray-900">Grand Totals</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ grand_totals.contributions|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ grand_totals.mission_allocation|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ grand_totals.branch_retained|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ grand_totals.expenditures|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">{{ grand_totals.payroll|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right
                                {% if grand_totals.net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ grand_totals.net_balance|floatformat:0|intcomma }}
                            </td>
                            <td colspan="2" class="px-6 py-4 text-sm text-gray-900"></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function applyFilters() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const area = document.getElementById('areaFilter').value;
    const district = document.getElementById('districtFilter').value;
    const branch = document.getElementById('branchFilter').value;
    
    const params = new URLSearchParams();
    if (year) params.append('year', year);
    if (month) params.append('month', month);
    if (area) params.append('area', area);
    if (district) params.append('district', district);
    if (branch) params.append('branch', branch);
    
    window.location.href = '{% url "auditing:financial_audit" %}?' + params.toString();
}

function exportToExcel() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    const area = document.getElementById('areaFilter').value;
    const district = document.getElementById('districtFilter').value;
    const branch = document.getElementById('branchFilter').value;
    
    const params = new URLSearchParams();
    if (year) params.append('year', year);
    if (month) params.append('month', month);
    if (area) params.append('area', area);
    if (district) params.append('district', district);
    if (branch) params.append('branch', branch);
    
    window.location.href = '{% url "auditing:export_audit_excel" %}?' + params.toString();
}

// Auto-filter hierarchy
document.getElementById('areaFilter').addEventListener('change', function() {
    document.getElementById('districtFilter').value = '';
    document.getElementById('branchFilter').value = '';
});

document.getElementById('districtFilter').addEventListener('change', function() {
    document.getElementById('branchFilter').value = '';
});
</script>
{% endblock %}
