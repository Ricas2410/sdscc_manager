{% extends 'base.html' %}
{% load humanize %}

{% block title %}My Payroll{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">My Payroll</h1>
            <p class="text-gray-500">View your salary details, payslips, and payment history</p>
        </div>
        {% if staff_profile %}
        <div class="flex items-center gap-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <span class="material-icons text-xs mr-1">check_circle</span>
                Active Employee
            </span>
            <span class="text-sm text-gray-500">ID: {{ staff_profile.employee_id }}</span>
        </div>
        {% endif %}
    </div>
    
    {% if staff_profile %}
    <!-- Staff Profile Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Employment Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <p class="text-sm font-medium text-gray-600">Position</p>
                <p class="text-sm text-gray-900 mt-1">{{ staff_profile.position }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600">Department</p>
                <p class="text-sm text-gray-900 mt-1">{{ staff_profile.department|default:"Not specified" }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600">Employment Type</p>
                <p class="text-sm text-gray-900 mt-1">{{ staff_profile.get_employment_type_display }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600">Base Salary</p>
                <p class="text-sm font-bold text-gray-900 mt-1">GH₵{{ staff_profile.base_salary|floatformat:2|intcomma }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600">Payment Cycle</p>
                <p class="text-sm text-gray-900 mt-1">{{ staff_profile.get_payment_cycle_display }}</p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-600">Hire Date</p>
                <p class="text-sm text-gray-900 mt-1">{{ staff_profile.hire_date|date:"M d, Y" }}</p>
            </div>
        </div>
        
        {% if staff_profile.bank_name %}
        <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Bank Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-xs text-gray-600">Bank Name</p>
                    <p class="text-sm text-gray-900">{{ staff_profile.bank_name }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-600">Account Number</p>
                    <p class="text-sm text-gray-900">{{ staff_profile.bank_account_number }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-600">Branch</p>
                    <p class="text-sm text-gray-900">{{ staff_profile.bank_branch|default:"Not specified" }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Payroll Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Earned (YTD)</p>
                    <p class="text-2xl font-bold text-gray-900">GH₵{{ total_paid|floatformat:2|intcomma }}</p>
                </div>
                <span class="material-icons-outlined text-3xl text-green-500">account_balance_wallet</span>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Pending Payments</p>
                    <p class="text-2xl font-bold text-orange-600">GH₵{{ total_pending|floatformat:2|intcomma }}</p>
                </div>
                <span class="material-icons-outlined text-3xl text-orange-500">pending</span>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Last Payment</p>
                    <p class="text-2xl font-bold text-blue-600">
                        {% if payslips.0 %}GH₵{{ payslips.0.net_pay|floatformat:2|intcomma }}{% else %}--{% endif %}
                    </p>
                </div>
                <span class="material-icons-outlined text-3xl text-blue-500">payments</span>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Payslips</p>
                    <p class="text-2xl font-bold text-purple-600">{{ payslips|length }}</p>
                </div>
                <span class="material-icons-outlined text-3xl text-purple-500">description</span>
            </div>
        </div>
    </div>
    
    <!-- Payslips Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-900">Payslip History</h2>
            <div class="flex items-center gap-3">
                <select id="yearFilter" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Years</option>
                    {% for year in available_years %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
                <select id="statusFilter" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base Salary</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Allowances</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deductions</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Pay</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Pay</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="payslipsTableBody">
                    {% for payslip in payslips %}
                    <tr class="hover:bg-gray-50" data-year="{{ payslip.payroll_run.year }}" data-status="{{ payslip.status }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ payslip.payroll_run.month_name }} {{ payslip.payroll_run.year }}
                            </div>
                            {% if payslip.payment_date %}
                            <div class="text-xs text-gray-500">Paid: {{ payslip.payment_date|date:"M d, Y" }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">GH₵{{ payslip.base_salary|floatformat:2|intcomma }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-green-600">+GH₵{{ payslip.total_allowances|floatformat:2|intcomma }}</div>
                            {% if payslip.allowances_breakdown %}
                            <button onclick="showBreakdown('allowances', '{{ payslip.allowances_breakdown|escapejs }}')" class="text-xs text-blue-600 hover:text-blue-800">
                                View details
                            </button>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-red-600">-GH₵{{ payslip.total_deductions|floatformat:2|intcomma }}</div>
                            {% if payslip.deductions_breakdown %}
                            <button onclick="showBreakdown('deductions', '{{ payslip.deductions_breakdown|escapejs }}')" class="text-xs text-blue-600 hover:text-blue-800">
                                View details
                            </button>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">GH₵{{ payslip.gross_pay|floatformat:2|intcomma }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-green-600">GH₵{{ payslip.net_pay|floatformat:2|intcomma }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if payslip.status == 'paid' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <span class="material-icons text-xs mr-1">check_circle</span>Paid
                            </span>
                            {% elif payslip.status == 'approved' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <span class="material-icons text-xs mr-1">verified</span>Approved
                            </span>
                            {% elif payslip.status == 'pending' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <span class="material-icons text-xs mr-1">pending</span>Pending
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <span class="material-icons text-xs mr-1">help</span>{{ payslip.get_status_display }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="viewPayslip('{{ payslip.id }}')" class="text-blue-600 hover:text-blue-900">
                                <span class="material-icons-outlined text-lg">visibility</span>
                            </button>
                            {% if payslip.status == 'paid' %}
                            <button onclick="downloadPayslip('{{ payslip.id }}')" class="text-green-600 hover:text-green-900">
                                <span class="material-icons-outlined text-lg">download</span>
                            </button>
                            {% endif %}
                            {% if payslip.notes %}
                            <button onclick="showNotes('{{ payslip.notes|escapejs }}')" class="text-gray-600 hover:text-gray-900">
                                <span class="material-icons-outlined text-lg">note</span>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <span class="material-icons-outlined text-5xl text-gray-300">description</span>
                            <p class="mt-2 text-gray-500">No payslips found</p>
                            <p class="text-sm text-gray-400 mt-1">Payslips will appear here when payroll is processed</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    {% else %}
    <!-- No Payroll Profile -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <div class="flex items-start gap-3">
            <span class="material-icons text-yellow-600 mt-0.5">warning</span>
            <div>
                <p class="font-medium text-yellow-800">No Payroll Profile Found</p>
                <p class="text-sm text-yellow-700 mt-1">
                    You don't have a payroll profile set up yet. Please contact the mission administrator to set up your payroll details.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Payroll Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <span class="material-icons text-blue-600 mt-0.5">info</span>
            <div>
                <p class="font-medium text-blue-800">About Your Payroll</p>
                <p class="text-sm text-blue-700 mt-1">
                    Your payroll is processed according to your payment cycle. Payslips show detailed breakdown of your salary, allowances, and deductions. 
                    Contact the mission administrator if you have any questions about your payroll.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Breakdown Modal -->
<div id="breakdownModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <h3 id="breakdownTitle" class="text-lg font-medium text-gray-900 mb-4"></h3>
            <div id="breakdownContent" class="space-y-2"></div>
            <div class="mt-4">
                <button onclick="closeBreakdownModal()" class="btn-secondary w-full">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div id="notesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Payslip Notes</h3>
            <p id="notesContent" class="text-sm text-gray-600"></p>
            <div class="mt-4">
                <button onclick="closeNotesModal()" class="btn-secondary w-full">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Filter functionality
document.getElementById('yearFilter').addEventListener('change', filterPayslips);
document.getElementById('statusFilter').addEventListener('change', filterPayslips);

function filterPayslips() {
    const yearFilter = document.getElementById('yearFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#payslipsTableBody tr');
    
    rows.forEach(row => {
        const year = row.dataset.year;
        const status = row.dataset.status;
        
        const yearMatch = !yearFilter || year === yearFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        
        row.style.display = yearMatch && statusMatch ? '' : 'none';
    });
}

function showBreakdown(type, breakdownString) {
    const modal = document.getElementById('breakdownModal');
    const title = document.getElementById('breakdownTitle');
    const content = document.getElementById('breakdownContent');
    
    title.textContent = type === 'allowances' ? 'Allowances Breakdown' : 'Deductions Breakdown';
    
    // Parse the JSON string
    const breakdown = JSON.parse(breakdownString);
    
    content.innerHTML = '';
    for (const [name, amount] of Object.entries(breakdown)) {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center py-2 border-b border-gray-100';
        div.innerHTML = `
            <span class="text-sm text-gray-600">${name}</span>
            <span class="text-sm font-medium ${type === 'allowances' ? 'text-green-600' : 'text-red-600'}">
                ${type === 'allowances' ? '+' : '-'}GH₵${parseFloat(amount).toFixed(2)}
            </span>
        `;
        content.appendChild(div);
    }
    
    modal.classList.remove('hidden');
}

function closeBreakdownModal() {
    document.getElementById('breakdownModal').classList.add('hidden');
}

function showNotes(notes) {
    document.getElementById('notesContent').textContent = notes;
    document.getElementById('notesModal').classList.remove('hidden');
}

function closeNotesModal() {
    document.getElementById('notesModal').classList.add('hidden');
}

function viewPayslip(payslipId) {
    window.open(`/payroll/payslip/${payslipId}/`, '_blank');
}

function downloadPayslip(payslipId) {
    window.open(`/payroll/payslip/${payslipId}/download/`, '_blank');
}
</script>
{% endblock %}
