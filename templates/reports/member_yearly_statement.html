{% extends 'base.html' %}
{% load humanize %}

{% block title %}Member Contribution Statement - {{ year }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Yearly Contribution Statement</h1>
            <p class="mt-1 text-gray-600">Year {{ year }} • Generated {{ generated_date|date:"F d, Y" }}</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Filters -->
            <form method="GET" id="filterForm" class="flex items-center gap-2">
                {% if user.is_mission_admin or user.is_auditor %}
                <div class="flex items-center gap-2 border-r border-gray-300 pr-2">
                    <!-- Area Filter -->
                    <select id="areaFilter" name="area" 
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Areas</option>
                        {% for area in areas %}
                        <option value="{{ area.id }}" {% if request.GET.area == area.id|stringformat:"s" %}selected{% endif %}>{{ area.name }}</option>
                        {% endfor %}
                    </select>
                    
                    <!-- District Filter -->
                    <select id="districtFilter" name="district" 
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Districts</option>
                        {% for district in districts %}
                        <option value="{{ district.id }}" {% if request.GET.district == district.id|stringformat:"s" %}selected{% endif %}>{{ district.name }}</option>
                        {% endfor %}
                    </select>
                    
                    <!-- Branch Filter -->
                    <select id="branchFilter" name="branch" 
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if request.GET.branch == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Member Search -->
                <div class="relative">
                    <input type="text" 
                           id="memberSearch" 
                           placeholder="Search member..." 
                           class="px-4 py-2 pr-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64"
                           autocomplete="off"
                           value="{% if member %}{{ member.get_full_name|escapejs }} ({{ member.member_id|default:member.branch.code|escapejs }}){% endif %}">
                    <span class="material-icons-outlined absolute right-3 top-2.5 text-gray-400">search</span>
                    
                    <!-- Hidden dropdown for search results -->
                    <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50">
                        <!-- Results will be populated here -->
                    </div>
                    
                    <!-- Hidden input to store selected member ID -->
                    <input type="hidden" name="member" id="selectedMember" value="{{ member.id|default:'' }}">
                </div>
                {% endif %}
                <select name="year" onchange="document.getElementById('filterForm').submit()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for y in available_years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}">{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
            {% if member %}
            <!-- Export Buttons -->
            <div class="flex items-center gap-3">
                <!-- Export Excel -->
                <a href="{% url 'reports:export_member_yearly_excel' %}?member={{ member.id }}&year={{ year }}" 
                   class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                    <span class="material-icons-outlined text-lg mr-2">table_chart</span>
                    Export Excel
                </a>
                <!-- Export PDF -->
                <a href="{% url 'reports:export_member_yearly_pdf' %}?member={{ member.id }}&year={{ year }}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    <span class="material-icons-outlined text-lg mr-2">picture_as_pdf</span>
                    Export PDF
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    {% if not member %}
    <!-- No Member Selected -->
    <div class="bg-gray-50 rounded-2xl p-12 text-center">
        <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-icons-outlined text-gray-400 text-4xl">person_search</span>
        </div>
        <h2 class="text-xl font-bold text-gray-700 mb-2">Select a Member</h2>
        <p class="text-gray-500 max-w-md mx-auto">
            Please select a member from the dropdown above to view their yearly contribution statement.
        </p>
    </div>
    {% else %}

    <!-- Member Header Card -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 mb-8 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold">
                    {{ member.first_name|slice:":1" }}{{ member.last_name|slice:":1" }}
                </div>
                <div>
                    <h2 class="text-2xl font-bold">{{ member.get_full_name }}</h2>
                    <p class="text-blue-200">
                        Member ID: {{ member.member_id|default:"N/A" }} • 
                        {{ member.branch.name|default:"No Branch" }}
                    </p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-blue-200 text-sm">Statement Period</p>
                <p class="font-semibold">January 1, {{ year }} - December 31, {{ year }}</p>
            </div>
        </div>
    </div>

    <!-- Total Contribution Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium mb-1">Total Contributions for {{ year }}</p>
                <p class="text-4xl font-bold text-gray-900">{{ site_settings.currency_symbol }}{{ total_contributions|floatformat:2|intcomma }}</p>
            </div>
            <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center">
                <span class="material-icons-outlined text-blue-600 text-3xl">volunteer_activism</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Contribution Breakdown by Type -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-900 flex items-center">
                    <span class="material-icons-outlined text-blue-600 mr-2">category</span>
                    Contribution Breakdown
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    {% for item in contributions_by_type %}
                    <div class="flex justify-between items-center py-3 border-b border-gray-50">
                        <div>
                            <span class="font-medium text-gray-900">{{ item.contribution_type__name }}</span>
                            <span class="text-gray-400 text-xs ml-2">({{ item.count }} contributions)</span>
                        </div>
                        <span class="font-semibold text-gray-900">{{ site_settings.currency_symbol }}{{ item.total|floatformat:2|intcomma }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 text-center py-4">No contributions recorded for {{ year }}</p>
                    {% endfor %}
                    {% if contributions_by_type %}
                    <div class="flex justify-between items-center py-3 bg-blue-50 -mx-6 px-6 rounded-lg mt-4">
                        <span class="font-bold text-blue-800">Total</span>
                        <span class="font-bold text-blue-800">{{ site_settings.currency_symbol }}{{ total_contributions|floatformat:2|intcomma }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Monthly Summary -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-900 flex items-center">
                    <span class="material-icons-outlined text-emerald-600 mr-2">calendar_month</span>
                    Monthly Summary
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-2">
                    {% for item in monthly_totals %}
                    <div class="flex justify-between items-center py-2 {% if item.total > 0 %}text-gray-900{% else %}text-gray-400{% endif %}">
                        <span>{{ item.month_name }}</span>
                        <span class="font-medium">{{ site_settings.currency_symbol }}{{ item.total|floatformat:2|intcomma }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Declaration Statement -->
    <div class="mt-8 bg-gray-50 rounded-xl p-6 border border-gray-200">
        <h3 class="font-bold text-gray-900 mb-4 flex items-center">
            <span class="material-icons-outlined text-gray-600 mr-2">verified</span>
            Official Declaration
        </h3>
        <div class="text-sm text-gray-700 space-y-3">
            <p>
                This is to certify that <strong>{{ member.get_full_name }}</strong> 
                (Member ID: <strong>{{ member.member_id|default:"N/A" }}</strong>) 
                has contributed a total of <strong>{{ site_settings.currency_symbol }}{{ total_contributions|floatformat:2|intcomma }}</strong> 
                to <strong>{{ site_settings.site_name }}</strong> during the year <strong>{{ year }}</strong>.
            </p>
            <p>
                This statement is generated from official church records and is provided for the member's personal records.
            </p>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide mb-2">Generated By</p>
                        <p class="font-medium">{{ site_settings.site_name }}</p>
                        <p class="text-gray-500">{{ generated_date|date:"F d, Y" }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide mb-2">Member's Branch</p>
                        <p class="font-medium">{{ member.branch.name|default:"N/A" }}</p>
                        <p class="text-gray-500">{{ member.branch.district.name|default:"" }} {% if member.branch.district %}District{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Details -->
    <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="font-bold text-gray-900 mb-4 flex items-center">
            <span class="material-icons-outlined text-gray-600 mr-2">person</span>
            Member Details
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            <div>
                <p class="text-gray-500 mb-1">Full Name</p>
                <p class="font-medium text-gray-900">{{ member.get_full_name }}</p>
            </div>
            <div>
                <p class="text-gray-500 mb-1">Member ID</p>
                <p class="font-medium text-gray-900">{{ member.member_id|default:"Not Assigned" }}</p>
            </div>
            <div>
                <p class="text-gray-500 mb-1">Branch</p>
                <p class="font-medium text-gray-900">{{ member.branch.name|default:"Not Assigned" }}</p>
            </div>
            <div>
                <p class="text-gray-500 mb-1">Email</p>
                <p class="font-medium text-gray-900">{{ member.email|default:"Not Provided" }}</p>
            </div>
            <div>
                <p class="text-gray-500 mb-1">Phone</p>
                <p class="font-medium text-gray-900">{{ member.phone|default:"Not Provided" }}</p>
            </div>
            <div>
                <p class="text-gray-500 mb-1">Status</p>
                <p class="font-medium text-gray-900">{{ member.get_role_display|default:"Member" }}</p>
            </div>
        </div>
    </div>

    {% endif %}

    <!-- Back Link -->
    <div class="mt-8">
        <a href="{% url 'reports:yearly_reports_index' %}" class="inline-flex items-center text-gray-600 hover:text-gray-900">
            <span class="material-icons-outlined text-lg mr-1">arrow_back</span>
            Back to Yearly Reports
        </a>
    </div>
</div>

{% if user.is_mission_admin or user.is_auditor %}
<script>
// Hierarchical filtering and member search functionality
const areaFilter = document.getElementById('areaFilter');
const districtFilter = document.getElementById('districtFilter');
const branchFilter = document.getElementById('branchFilter');
const memberSearch = document.getElementById('memberSearch');
const searchResults = document.getElementById('searchResults');
const selectedMemberInput = document.getElementById('selectedMember');
const filterForm = document.getElementById('filterForm');
let searchTimeout;

// Store members data from JSON script tag
const allMembers = JSON.parse(document.getElementById('membersData').textContent);

// Area filter change handler - submit form to update hierarchy
areaFilter.addEventListener('change', function() {
    // Clear member search when hierarchy changes
    memberSearch.value = '';
    selectedMemberInput.value = '';
    
    // Submit form to get updated districts, branches, and members
    filterForm.submit();
});

// District filter change handler - submit form to update hierarchy
districtFilter.addEventListener('change', function() {
    // Clear member search when hierarchy changes
    memberSearch.value = '';
    selectedMemberInput.value = '';
    
    // Submit form to get updated branches and members
    filterForm.submit();
});

// Branch filter change handler - submit form to update members
branchFilter.addEventListener('change', function() {
    // Clear member search when hierarchy changes
    memberSearch.value = '';
    selectedMemberInput.value = '';
    
    // Submit form to get updated members
    filterForm.submit();
});

// Member search functionality
memberSearch.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.toLowerCase().trim();
    
    if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
    }
    
    searchTimeout = setTimeout(() => {
        // Search through all available members (already filtered by backend)
        const results = allMembers.filter(member => 
            member.searchText.includes(query)
        );
        
        displaySearchResults(results);
    }, 300);
});

memberSearch.addEventListener('focus', function() {
    if (this.value.length >= 2) {
        const query = this.value.toLowerCase().trim();
        
        // Search through all available members (already filtered by backend)
        const results = allMembers.filter(member => 
            member.searchText.includes(query)
        );
        
        displaySearchResults(results);
    }
});

function displaySearchResults(results) {
    if (results.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-gray-500 text-sm">No members found</div>';
    } else {
        searchResults.innerHTML = results.slice(0, 10).map(member => `
            <div class="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                 onclick="selectMember('${member.id}', '${member.name}', '${member.memberId}', '${member.branch}')">
                <div class="font-medium text-gray-900">${member.name}</div>
                <div class="text-sm text-gray-500">
                    ID: ${member.memberId || 'N/A'} • ${member.branch}
                    ${member.district ? ` • ${member.district} District` : ''}
                    ${member.area ? ` • ${member.area} Area` : ''}
                </div>
            </div>
        `).join('');
    }
    
    searchResults.classList.remove('hidden');
}

function selectMember(id, name, memberId, branch) {
    selectedMemberInput.value = id;
    memberSearch.value = `${name} (${memberId || branch})`;
    searchResults.classList.add('hidden');
    
    // Submit the form
    filterForm.submit();
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!memberSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
    }
});

// Handle keyboard navigation
memberSearch.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        searchResults.classList.add('hidden');
    }
});
</script>

<!-- Hidden script tag to store member data as JSON -->
<script type="application/json" id="membersData">
[
    {% for m in members %}
    {
        "id": "{{ m.id }}",
        "name": "{{ m.get_full_name|escapejs }}",
        "memberId": "{{ m.member_id|default:""|escapejs }}",
        "branch": "{{ m.branch.name|default:"No Branch"|escapejs }}",
        "branchId": "{{ m.branch.id }}",
        "district": "{{ m.branch.district.name|default:""|escapejs }}",
        "districtId": "{{ m.branch.district.id }}",
        "area": "{{ m.branch.district.area.name|default:""|escapejs }}",
        "areaId": "{{ m.branch.district.area.id }}",
        "searchText": "{{ m.get_full_name|escapejs }} {{ m.member_id|default:""|escapejs }} {{ m.branch.name|default:""|escapejs }} {{ m.branch.district.name|default:""|escapejs }} {{ m.branch.district.area.name|default:""|escapejs }}".toLowerCase()
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
{% endif %}

{% endblock %}
