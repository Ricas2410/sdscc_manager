{% extends 'base.html' %}
{% load static %}

{% block title %}Final Financial Report - {{ month_name }} {{ year }}{% endblock %}

{% block extra_head %}
<style>
/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    .card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #e5e7eb !important;
        margin-bottom: 1rem !important;
    }
    
    .card-header {
        background: #f9fafb !important;
        border-bottom: 1px solid #e5e7eb !important;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.4;
    }
    
    .container-fluid {
        max-width: 100%;
        padding: 0 !important;
    }
    
    h1 {
        font-size: 18pt;
        margin-bottom: 0.5rem;
    }
    
    h2 {
        font-size: 14pt;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .grid {
        display: block !important;
    }
    
    .grid > div {
        margin-bottom: 1rem;
        display: block;
    }
    
    .bg-gradient-to-br {
        background: #f3f4f6 !important;
        color: #1f2937 !important;
    }
    
    canvas {
        max-height: 200px !important;
    }
    
    /* Church Letterhead */
    .letterhead {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #1f2937;
    }
    
    .letterhead h1 {
        font-size: 20pt;
        font-weight: bold;
        margin: 0;
        color: #1f2937;
    }
    
    .letterhead p {
        margin: 0.25rem 0;
        color: #6b7280;
    }
}

/* Enhanced Visual Styles */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

.data-table th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.data-table tr:hover {
    background-color: #f8fafc;
}

.status-positive {
    color: #059669;
    font-weight: 600;
}

.status-negative {
    color: #dc2626;
    font-weight: 600;
}

.summary-card {
    position: relative;
    overflow: hidden;
}

.summary-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
}
</style>
{% endblock %}

{% block content %}
<!-- Church Letterhead for Print -->
<div class="letterhead no-print" style="display: none;">
    <h1>{{ site_settings.church_name|default:"SDSCC Church" }}</h1>
    <p>{{ site_settings.address|default:"Church Address" }}</p>
    <p>{{ site_settings.phone|default:"Phone Number" }} | {{ site_settings.email|default:"Email Address" }}</p>
</div>

<div class="container-fluid px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Final Financial Report</h1>
                <p class="text-slate-600 mt-1">Comprehensive Income vs Expenditure - {{ month_name }} {{ year }}</p>
            </div>
            <div class="flex gap-2 no-print">
                <button onclick="exportToExcel('all')" class="btn btn-success">
                    <span class="material-icons-outlined text-lg mr-2">file_download</span>
                    Export Excel
                </button>
                <button onclick="window.print()" class="btn btn-secondary">
                    <span class="material-icons-outlined text-lg mr-2">print</span>
                    Print Report
                </button>
                <a href="{% url 'reports:index' %}" class="btn btn-secondary">
                    <span class="material-icons-outlined text-lg mr-2">arrow_back</span>
                    Back to Reports
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="filter-section mb-6">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[150px]">
                <label class="form-label">Month</label>
                <select name="month" class="form-input form-select">
                    {% for m, name in months %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="form-label">Year</label>
                <select name="year" class="form-input form-select">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">
                <span class="material-icons-outlined text-lg mr-2">search</span>
                Generate Report
            </button>
        </form>
    </div>

    <!-- Overall Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white overflow-hidden">
            <div class="card-body p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium mb-2 opacity-90">Total Income</p>
                        <h3 class="text-3xl font-bold">{{ site_settings.currency_symbol }}{{ overall_income|floatformat:2 }}</h3>
                    </div>
                    <div class="bg-white/20 p-3 rounded-full">
                        <span class="material-icons text-4xl">account_balance_wallet</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white overflow-hidden">
            <div class="card-body p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium mb-2 opacity-90">Total Expenditure</p>
                        <h3 class="text-3xl font-bold">{{ site_settings.currency_symbol }}{{ overall_expenditure|floatformat:2 }}</h3>
                    </div>
                    <div class="bg-white/20 p-3 rounded-full">
                        <span class="material-icons text-4xl">receipt_long</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card bg-gradient-to-br {% if overall_balance >= 0 %}from-green-500 to-green-600{% else %}from-orange-500 to-orange-600{% endif %} text-white overflow-hidden">
            <div class="card-body p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="{% if overall_balance >= 0 %}text-green-100{% else %}text-orange-100{% endif %} text-sm font-medium mb-2 opacity-90">Net Balance</p>
                        <h3 class="text-3xl font-bold">{{ site_settings.currency_symbol }}{{ overall_balance|floatformat:2 }}</h3>
                    </div>
                    <div class="bg-white/20 p-3 rounded-full">
                        <span class="material-icons text-4xl">{% if overall_balance >= 0 %}trending_up{% else %}trending_down{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Level Section -->
    <div class="card mb-8 shadow-lg">
        <div class="card-header bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200">
            <h2 class="text-xl font-bold text-blue-900 flex items-center">
                <span class="material-icons-outlined mr-2 text-blue-600">account_balance</span>
                Mission Level Finances
            </h2>
        </div>
        <div class="card-body p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Mission Income -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-6 flex items-center">
                        <span class="material-icons-outlined mr-2 text-green-600">trending_up</span>
                        Income
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-600">account_balance_wallet</span>
                                <span class="text-slate-700 font-medium">Remittances from Branches</span>
                            </div>
                            <span class="font-bold text-green-700 text-lg">{{ site_settings.currency_symbol }}{{ total_remittances|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-600">add_circle</span>
                                <span class="text-slate-700 font-medium">Other Mission Income</span>
                            </div>
                            <span class="font-bold text-green-700 text-lg">{{ site_settings.currency_symbol }}{{ mission_other_income|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-100 to-green-50 rounded-lg border-2 border-green-300">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-700">sum</span>
                                <span class="font-bold text-slate-900">Total Mission Income</span>
                            </div>
                            <span class="font-bold text-green-800 text-xl">{{ site_settings.currency_symbol }}{{ total_mission_income|floatformat:2 }}</span>
                        </div>
                    </div>
                    
                    <!-- Mission Income Chart -->
                    <div class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="missionIncomeChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Mission Expenditure -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-6 flex items-center">
                        <span class="material-icons-outlined mr-2 text-red-600">trending_down</span>
                        Expenditure
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">people</span>
                                <span class="text-slate-700 font-medium">Staff Payroll</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ total_payroll|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">receipt_long</span>
                                <span class="text-slate-700 font-medium">Mission Expenses</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ mission_expenses|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">call_made</span>
                                <span class="text-slate-700 font-medium">Returns to Branches</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ mission_returns|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-red-100 to-red-50 rounded-lg border-2 border-red-300">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-700">sum</span>
                                <span class="font-bold text-slate-900">Total Mission Expenditure</span>
                            </div>
                            <span class="font-bold text-red-800 text-xl">{{ site_settings.currency_symbol }}{{ total_mission_expenditure|floatformat:2 }}</span>
                        </div>
                    </div>
                    
                    <!-- Mission Expense Chart -->
                    <div class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="missionExpenseChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Mission Net Balance -->
            <div class="mt-8 p-6 bg-gradient-to-r {% if mission_net_balance >= 0 %}from-green-100 to-green-50{% else %}from-orange-100 to-orange-50{% endif %} rounded-xl border-2 {% if mission_net_balance >= 0 %}border-green-300{% else %}border-orange-300{% endif %} shadow-lg">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="material-icons-outlined mr-3 text-2xl {% if mission_net_balance >= 0 %}text-green-600{% else %}text-orange-600{% endif %}">{% if mission_net_balance >= 0 %}account_balance{% else %}warning{% endif %}</span>
                        <span class="text-xl font-bold text-slate-900">Mission Net Balance</span>
                    </div>
                    <span class="text-3xl font-bold {% if mission_net_balance >= 0 %}text-green-700{% else %}text-orange-700{% endif %}">
                        {{ site_settings.currency_symbol }}{{ mission_net_balance|floatformat:2 }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Branch Level Summary -->
    <div class="card mb-8 shadow-lg">
        <div class="card-header bg-gradient-to-r from-green-50 to-green-100 border-b border-green-200">
            <h2 class="text-xl font-bold text-green-900 flex items-center">
                <span class="material-icons-outlined mr-2 text-green-600">store</span>
                Branch Level Aggregates
            </h2>
        </div>
        <div class="card-body p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Branch Income -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-6 flex items-center">
                        <span class="material-icons-outlined mr-2 text-green-600">trending_up</span>
                        Income (All Branches)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-600">account_balance_wallet</span>
                                <span class="text-slate-700 font-medium">Tithe</span>
                            </div>
                            <span class="font-bold text-green-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_tithe|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-600">volunteer_activism</span>
                                <span class="text-slate-700 font-medium">Offerings</span>
                            </div>
                            <span class="font-bold text-green-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_offerings|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-600">add_circle</span>
                                <span class="text-slate-700 font-medium">Other Contributions</span>
                            </div>
                            <span class="font-bold text-green-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_other|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-100 to-green-50 rounded-lg border-2 border-green-300">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-green-700">sum</span>
                                <span class="font-bold text-slate-900">Total Branch Income</span>
                            </div>
                            <span class="font-bold text-green-800 text-xl">{{ site_settings.currency_symbol }}{{ total_branch_income|floatformat:2 }}</span>
                        </div>
                    </div>
                    
                    <!-- Branch Income Chart -->
                    <div class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="branchIncomeChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Branch Expenditure -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-6 flex items-center">
                        <span class="material-icons-outlined mr-2 text-red-600">trending_down</span>
                        Expenditure (All Branches)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">receipt_long</span>
                                <span class="text-slate-700 font-medium">Branch Expenses</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_expenses|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">call_made</span>
                                <span class="text-slate-700 font-medium">Remittance to Mission</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_remitted|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg border border-red-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-600">percent</span>
                                <span class="text-slate-700 font-medium">Pastor Commission</span>
                            </div>
                            <span class="font-bold text-red-700 text-lg">{{ site_settings.currency_symbol }}{{ total_branch_commission|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-red-100 to-red-50 rounded-lg border-2 border-red-300">
                            <div class="flex items-center">
                                <span class="material-icons-outlined mr-3 text-red-700">sum</span>
                                <span class="font-bold text-slate-900">Total Branch Expenditure</span>
                            </div>
                            <span class="font-bold text-red-800 text-xl">{{ site_settings.currency_symbol }}{{ total_branch_expenditure|floatformat:2 }}</span>
                        </div>
                    </div>
                    
                    <!-- Branch Expense Chart -->
                    <div class="mt-6 bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="branchExpenseChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Branch Net Balance -->
            <div class="mt-8 p-6 bg-gradient-to-r {% if total_branch_balance >= 0 %}from-green-100 to-green-50{% else %}from-orange-100 to-orange-50{% endif %} rounded-xl border-2 {% if total_branch_balance >= 0 %}border-green-300{% else %}border-orange-300{% endif %} shadow-lg">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="material-icons-outlined mr-3 text-2xl {% if total_branch_balance >= 0 %}text-green-600{% else %}text-orange-600{% endif %}">{% if total_branch_balance >= 0 %}account_balance{% else %}warning{% endif %}</span>
                        <span class="text-xl font-bold text-slate-900">Total Branch Balance (Retained)</span>
                    </div>
                    <span class="text-3xl font-bold {% if total_branch_balance >= 0 %}text-green-700{% else %}text-orange-700{% endif %}">
                        {{ site_settings.currency_symbol }}{{ total_branch_balance|floatformat:2 }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Branches by Income -->
    <div class="card mb-8 shadow-lg">
        <div class="card-header bg-gradient-to-r from-purple-50 to-purple-100 border-b border-purple-200">
            <h2 class="text-xl font-bold text-purple-900 flex items-center">
                <span class="material-icons-outlined mr-2 text-purple-600">leaderboard</span>
                Top 10 Branches by Income
            </h2>
        </div>
        <div class="card-body p-6">
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <canvas id="topBranchesChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Branch-by-Branch Details -->
    <div class="card shadow-lg">
        <div class="card-header bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-900 flex items-center">
                <span class="material-icons-outlined mr-2 text-slate-600">table_chart</span>
                Branch-by-Branch Breakdown
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Branch</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Tithe</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Offerings</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Other</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Total Income</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Expenses</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Remittance</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Commission</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Total Expenditure</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Balance</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {% for item in branch_data %}
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-slate-900">{{ item.branch.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.tithe|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.offerings|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.other_income|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold text-green-700">{{ site_settings.currency_symbol }}{{ item.total_income|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.expenses|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.remittance|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-700">{{ site_settings.currency_symbol }}{{ item.commission|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold text-red-700">{{ site_settings.currency_symbol }}{{ item.total_expenditure|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold {% if item.balance >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                            {{ site_settings.currency_symbol }}{{ item.balance|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '{{ site_settings.currency_symbol }}' + context.parsed.toFixed(2);
                        return label;
                    }
                }
            }
        }
    };

    // Mission Income Chart
    const missionIncomeData = {{ mission_income_chart|safe }};
    new Chart(document.getElementById('missionIncomeChart'), {
        type: 'doughnut',
        data: {
            labels: missionIncomeData.labels,
            datasets: [{
                data: missionIncomeData.data,
                backgroundColor: ['#10b981', '#3b82f6'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: chartOptions
    });

    // Mission Expense Chart
    const missionExpenseData = {{ mission_expense_chart|safe }};
    new Chart(document.getElementById('missionExpenseChart'), {
        type: 'doughnut',
        data: {
            labels: missionExpenseData.labels,
            datasets: [{
                data: missionExpenseData.data,
                backgroundColor: ['#ef4444', '#f97316', '#f59e0b'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: chartOptions
    });

    // Branch Income Chart
    const branchIncomeData = {{ branch_income_chart|safe }};
    new Chart(document.getElementById('branchIncomeChart'), {
        type: 'doughnut',
        data: {
            labels: branchIncomeData.labels,
            datasets: [{
                data: branchIncomeData.data,
                backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: chartOptions
    });

    // Branch Expense Chart
    const branchExpenseData = {{ branch_expense_chart|safe }};
    new Chart(document.getElementById('branchExpenseChart'), {
        type: 'doughnut',
        data: {
            labels: branchExpenseData.labels,
            datasets: [{
                data: branchExpenseData.data,
                backgroundColor: ['#ef4444', '#f97316', '#f59e0b'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: chartOptions
    });

    // Top Branches Chart
    const topBranchesData = {{ top_branches_chart|safe }};
    new Chart(document.getElementById('topBranchesChart'), {
        type: 'bar',
        data: {
            labels: topBranchesData.labels,
            datasets: [{
                label: 'Total Income',
                data: topBranchesData.data,
                backgroundColor: '#3b82f6',
                borderColor: '#2563eb',
                borderWidth: 1
            }]
        },
        options: {
            ...chartOptions,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '{{ site_settings.currency_symbol }}' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Excel Export Function
    window.exportToExcel = function(type) {
        const wb = XLSX.utils.book_new();
        
        // Summary Data
        const summaryData = [
            ['Final Financial Report - {{ month_name }} {{ year }}'],
            [],
            ['Overall Summary'],
            ['Total Income', '{{ overall_income }}'],
            ['Total Expenditure', '{{ overall_expenditure }}'],
            ['Net Balance', '{{ overall_balance }}'],
            [],
            ['Mission Level Finances'],
            ['Remittances from Branches', '{{ total_remittances }}'],
            ['Other Mission Income', '{{ mission_other_income }}'],
            ['Total Mission Income', '{{ total_mission_income }}'],
            ['Staff Payroll', '{{ total_payroll }}'],
            ['Mission Expenses', '{{ mission_expenses }}'],
            ['Returns to Branches', '{{ mission_returns }}'],
            ['Total Mission Expenditure', '{{ total_mission_expenditure }}'],
            ['Mission Net Balance', '{{ mission_net_balance }}'],
            [],
            ['Branch Level Aggregates'],
            ['Total Branch Income', '{{ total_branch_income }}'],
            ['Total Branch Expenditure', '{{ total_branch_expenditure }}'],
            ['Total Branch Balance', '{{ total_branch_balance }}']
        ];
        
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        
        // Branch Details Data
        const branchData = [
            ['Branch', 'Tithe', 'Offerings', 'Other', 'Total Income', 'Expenses', 'Remittance', 'Commission', 'Total Expenditure', 'Balance']
        ];
        
        // Add branch data from JavaScript variable to avoid template parsing issues
        const branchDataFromServer = {{ branch_data_json|safe }};
        branchDataFromServer.forEach(item => {
            branchData.push([
                item.branch.name,
                item.tithe,
                item.offerings,
                item.other_income,
                item.total_income,
                item.expenses,
                item.remittance,
                item.commission,
                item.total_expenditure,
                item.balance
            ]);
        });
        
        const wsBranches = XLSX.utils.aoa_to_sheet(branchData);
        XLSX.utils.book_append_sheet(wb, wsBranches, 'Branch Details');
        
        // Save file
        const fileName = `Final_Financial_Report_{{ month_name }}_{{ year }}.xlsx`;
        XLSX.writeFile(wb, fileName);
    };
    
    // Print functionality with letterhead
    window.addEventListener('beforeprint', function() {
        // Show letterhead when printing
        const letterhead = document.querySelector('.letterhead');
        if (letterhead) {
            letterhead.style.display = 'block';
        }
    });
    
    window.addEventListener('afterprint', function() {
        // Hide letterhead after printing
        const letterhead = document.querySelector('.letterhead');
        if (letterhead) {
            letterhead.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
