{% extends 'base.html' %}
{% block title %}{% if can_edit %}Edit Profile{% else %}View Profile{% endif %}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{% if can_edit %}Edit Profile{% else %}My Profile{% endif %}</h1>
            <p class="text-gray-500 mt-1">{% if can_edit %}Update your personal information{% else %}Your personal information (read-only){% endif %}</p>
        </div>
        <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">
            <span class="material-icons-outlined mr-2">arrow_back</span>Back
        </a>
    </div>

    {% if not can_edit %}
    <!-- Notice Card -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <span class="material-icons-outlined text-blue-600 mt-0.5">info</span>
            <div>
                <h3 class="font-medium text-blue-800">Profile Information</h3>
                <p class="text-sm text-blue-700 mt-1">Your profile information is managed by the church administration. If you need to update any details, please contact your branch administrator.</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if can_edit %}
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
    {% endif %}
        
        <!-- Profile Picture -->
        <div class="card">
            <div class="card-body">
                <div class="flex items-center gap-6">
                    <div class="h-24 w-24 rounded-full bg-primary-100 flex items-center justify-center overflow-hidden flex-shrink-0">
                        {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" class="h-24 w-24 object-cover" id="current_photo">
                        {% else %}
                        <span class="text-4xl text-primary-600 font-bold">{{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}</span>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        {% if can_edit %}
                        <label class="form-label">Profile Picture</label>
                        <div class="space-y-3">
                            <div class="flex gap-3">
                                <button type="button" onclick="openCamera()" class="btn btn-secondary btn-sm">
                                    <span class="material-icons-outlined mr-2">camera_alt</span>Take Photo
                                </button>
                                <button type="button" onclick="document.getElementById('photo_input').click()" class="btn btn-secondary btn-sm">
                                    <span class="material-icons-outlined mr-2">upload</span>Upload Photo
                                </button>
                                {% if user.profile_picture %}
                                <button type="button" onclick="removePhoto()" class="btn btn-danger btn-sm">
                                    <span class="material-icons-outlined mr-2">delete</span>Remove
                                </button>
                                {% endif %}
                            </div>
                            <input type="file" id="photo_input" name="profile_picture" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handlePictureUpload(this)">
                            <input type="file" id="camera_input" accept="image/jpeg,image/png,image/gif,image/webp" capture="environment" style="display: none;" onchange="handlePictureUpload(this)">
                            <input type="hidden" id="photo_data" name="photo_data">
                            <p class="text-xs text-gray-500">JPG, PNG or GIF. Max 5MB. You can take a photo directly or upload from your device.</p>
                            <div id="upload_progress" class="hidden">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Uploading...</p>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-sm font-medium text-gray-700">Profile Picture</p>
                        <p class="text-sm text-gray-500">Contact administrator to change profile picture</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Information -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="material-icons-outlined mr-2 text-primary-600 align-middle">person</span>
                    Personal Information
                </h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="form-label{% if can_edit %} required{% endif %}">First Name</label>
                        {% if can_edit %}
                        <input type="text" name="first_name" value="{{ user.first_name }}" required class="form-input">
                        {% else %}
                        <input type="text" value="{{ user.first_name }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label{% if can_edit %} required{% endif %}">Last Name</label>
                        {% if can_edit %}
                        <input type="text" name="last_name" value="{{ user.last_name }}" required class="form-input">
                        {% else %}
                        <input type="text" value="{{ user.last_name }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        {% if can_edit %}
                        <input type="email" name="email" value="{{ user.email }}" class="form-input">
                        {% else %}
                        <input type="email" value="{{ user.email|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        {% if can_edit %}
                        <input type="tel" name="phone" value="{{ user.phone }}" class="form-input" placeholder="+233...">
                        {% else %}
                        <input type="tel" value="{{ user.phone|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        {% if can_edit %}
                        <input type="date" name="date_of_birth" value="{{ user.date_of_birth|date:'Y-m-d' }}" class="form-input">
                        {% else %}
                        <input type="text" value="{{ user.date_of_birth|date:'F d, Y'|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        {% if can_edit %}
                        <select name="gender" class="form-input form-select">
                            <option value="">Select Gender</option>
                            <option value="M" {% if user.gender == 'M' %}selected{% endif %}>Male</option>
                            <option value="F" {% if user.gender == 'F' %}selected{% endif %}>Female</option>
                        </select>
                        {% else %}
                        <input type="text" value="{{ user.get_gender_display|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Information -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="material-icons-outlined mr-2 text-primary-600 align-middle">home</span>
                    Address Information
                </h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Address</label>
                        {% if can_edit %}
                        <textarea name="address" rows="2" class="form-input">{{ profile.address }}</textarea>
                        {% else %}
                        <textarea rows="2" readonly class="form-input bg-gray-50">{{ profile.address|default:'Not provided' }}</textarea>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">City/Town</label>
                        {% if can_edit %}
                        <input type="text" name="city" value="{{ profile.city }}" class="form-input">
                        {% else %}
                        <input type="text" value="{{ profile.city|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Region</label>
                        {% if can_edit %}
                        <input type="text" name="region" value="{{ profile.region }}" class="form-input">
                        {% else %}
                        <input type="text" value="{{ profile.region|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="material-icons-outlined mr-2 text-primary-600 align-middle">info</span>
                    Additional Information
                </h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="form-label">Marital Status</label>
                        {% if can_edit %}
                        <select name="marital_status" class="form-input form-select">
                            <option value="">Select Status</option>
                            <option value="single" {% if profile.marital_status == 'single' %}selected{% endif %}>Single</option>
                            <option value="married" {% if profile.marital_status == 'married' %}selected{% endif %}>Married</option>
                            <option value="widowed" {% if profile.marital_status == 'widowed' %}selected{% endif %}>Widowed</option>
                            <option value="divorced" {% if profile.marital_status == 'divorced' %}selected{% endif %}>Divorced</option>
                        </select>
                        {% else %}
                        <input type="text" value="{{ profile.marital_status|title|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profession/Occupation</label>
                        {% if can_edit %}
                        <input type="text" name="profession" value="{{ profile.profession }}" class="form-input">
                        {% else %}
                        <input type="text" value="{{ profile.profession|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="material-icons-outlined mr-2 text-primary-600 align-middle">emergency</span>
                    Emergency Contact
                </h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label class="form-label">Contact Name</label>
                        {% if can_edit %}
                        <input type="text" name="emergency_contact_name" value="{{ profile.emergency_contact_name }}" class="form-input">
                        {% else %}
                        <input type="text" value="{{ profile.emergency_contact_name|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        {% if can_edit %}
                        <input type="tel" name="emergency_contact_phone" value="{{ profile.emergency_contact_phone }}" class="form-input">
                        {% else %}
                        <input type="tel" value="{{ profile.emergency_contact_phone|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Relationship</label>
                        {% if can_edit %}
                        <input type="text" name="emergency_contact_relationship" value="{{ profile.emergency_contact_relationship }}" class="form-input" placeholder="e.g., Spouse, Parent">
                        {% else %}
                        <input type="text" value="{{ profile.emergency_contact_relationship|default:'Not provided' }}" readonly class="form-input bg-gray-50">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if can_edit %}
        <!-- Submit -->
        <div class="flex justify-end gap-4">
            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary btn-lg">
                <span class="material-icons-outlined mr-2">save</span>
                Save Changes
            </button>
        </div>
        </form>
        {% else %}
        <!-- Account Actions -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="material-icons-outlined mr-2 text-primary-600 align-middle">settings</span>
                    Account Actions
                </h2>
            </div>
            <div class="card-body">
                <div class="space-y-3">
                    <a href="{% url 'accounts:change_password' %}" class="flex items-center p-3 border rounded-lg hover:bg-gray-50">
                        <span class="material-icons-outlined text-gray-400 mr-3">lock</span>
                        <div>
                            <p class="font-medium text-gray-900">Change Password</p>
                            <p class="text-sm text-gray-500">Update your password</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
</div>

<!-- Photo Upload JavaScript -->
{% if can_edit %}
<script>
function openCamera() {
    const cameraInput = document.getElementById('camera_input');
    cameraInput.click();
}

function handlePictureUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Client-side validation
    const maxSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    
    if (file.size > maxSize) {
        showUploadStatus('File is too large! Please choose an image smaller than 5MB.', 'error');
        input.value = '';
        return;
    }
    
    if (!allowedTypes.includes(file.type)) {
        showUploadStatus('Invalid file type! Please choose a JPG, PNG, GIF, or WebP image.', 'error');
        input.value = '';
        return;
    }
    
    // Show loading status
    showUploadStatus('Uploading...', 'loading');
    
    // Create FormData for AJAX upload
    const formData = new FormData();
    formData.append('photo', file);
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // AJAX upload
    fetch('{% url "accounts:upload_photo" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUploadStatus('Profile picture updated successfully!', 'success');
            // Update preview
            const preview = document.getElementById('current_photo');
            if (preview) {
                preview.src = data.photo_url;
            } else {
                const container = document.querySelector('.h-24.w-24');
                container.innerHTML = `<img src="${data.photo_url}" class="h-24 w-24 object-cover" id="current_photo">`;
            }
            // Show remove button if it doesn't exist
            updateRemoveButton(true);
        } else {
            showUploadStatus(data.message || 'Upload failed. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showUploadStatus('Upload failed. Please check your connection and try again.', 'error');
    })
    .finally(() => {
        // Clear the input
        input.value = '';
    });
}

function removePhoto() {
    if (!confirm('Are you sure you want to remove your profile picture?')) {
        return;
    }
    
    showUploadStatus('Removing...', 'loading');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // AJAX removal
    fetch('{% url "accounts:delete_photo" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUploadStatus('Profile picture removed successfully!', 'success');
            // Update preview
            const container = document.querySelector('.h-24.w-24');
            const firstName = '{{ user.first_name|slice:":1" }}';
            const lastName = '{{ user.last_name|slice:":1" }}';
            container.innerHTML = `<span class="text-4xl text-primary-600 font-bold">${firstName}${lastName}</span>`;
            // Hide remove button
            updateRemoveButton(false);
        } else {
            showUploadStatus(data.message || 'Failed to remove picture. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Remove error:', error);
        showUploadStatus('Failed to remove picture. Please check your connection and try again.', 'error');
    });
}

function showUploadStatus(message, type) {
    const progressDiv = document.getElementById('upload_progress');
    if (!progressDiv) return;
    
    progressDiv.classList.remove('hidden');
    const textElement = progressDiv.querySelector('p');
    
    if (textElement) {
        textElement.textContent = message;
        textElement.className = 'text-xs mt-1';
        
        if (type === 'success') {
            textElement.classList.add('text-green-600');
        } else if (type === 'error') {
            textElement.classList.add('text-red-600');
        } else if (type === 'loading') {
            textElement.classList.add('text-blue-600');
        }
    }
    
    // Hide progress bar for non-loading states
    const progressBar = progressDiv.querySelector('.w-full.bg-gray-200');
    if (progressBar) {
        progressBar.style.display = type === 'loading' ? 'block' : 'none';
    }
    
    // Clear status after 5 seconds for success/error messages
    if (type !== 'loading') {
        setTimeout(() => {
            progressDiv.classList.add('hidden');
        }, 5000);
    }
}

function updateRemoveButton(show) {
    const container = document.querySelector('.flex.gap-3');
    if (!container) return;
    
    const existingRemoveBtn = container.querySelector('button[onclick*="removePhoto"]');
    
    if (show && !existingRemoveBtn) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.onclick = removePhoto;
        removeBtn.className = 'btn btn-danger btn-sm';
        removeBtn.innerHTML = '<span class="material-icons-outlined mr-2">delete</span>Remove';
        container.appendChild(removeBtn);
    } else if (!show && existingRemoveBtn) {
        existingRemoveBtn.remove();
    }
}
</script>
{% endif %}
{% endblock %}
