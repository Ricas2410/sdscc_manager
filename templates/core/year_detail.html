{% extends 'base.html' %}

{% block title %}{{ year }} - Historical Summary{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex items-center gap-4">
            <a href="{% url 'core:archive_dashboard' %}" class="text-gray-500 hover:text-gray-700">
                <span class="material-icons-outlined">arrow_back</span>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ year }} - Historical Summary</h1>
                <p class="text-gray-500">{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            {% if has_cached_data %}
                <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full text-sm font-medium">
                    <span class="material-icons-outlined text-sm align-middle mr-1">cached</span>
                    Cached Data Available
                </span>
            {% endif %}
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                <span class="material-icons-outlined text-sm align-middle mr-1">calendar_today</span>
                Date-Based Summary
            </span>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <span class="material-icons-outlined text-blue-600 mt-0.5">info</span>
            <div>
                <h3 class="font-semibold text-blue-900 mb-1">Date-Based Historical Summary</h3>
                <p class="text-blue-700 text-sm">
                    This summary is computed live from core tables using date filtering ({{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}). 
                    No data movement or archiving occurs - all historical data remains accessible in real-time.
                </p>
            </div>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-green-600">trending_up</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Contributions</h2>
                        <p class="text-sm text-gray-500">Total income received</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold text-green-600">{{ contributions_total|currency }}</p>
                <p class="text-sm text-gray-500 mt-2">{{ contributions_count }} contributions</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-red-600">trending_down</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Expenditures</h2>
                        <p class="text-sm text-gray-500">Total expenses paid</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold text-red-600">{{ expenditures_total|currency }}</p>
                <p class="text-sm text-gray-500 mt-2">{{ expenditures_count }} expenditures</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-blue-600">account_balance</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Net Balance</h2>
                        <p class="text-sm text-gray-500">Contributions minus expenditures</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold {% if net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ net_balance|currency }}
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    {% if net_balance >= 0 %}Surplus{% else %}Deficit{% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Contribution Breakdown -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                    <span class="material-icons-outlined text-purple-600">pie_chart</span>
                </div>
                <div>
                    <h2 class="font-semibold text-gray-900">Contribution Breakdown</h2>
                    <p class="text-sm text-gray-500">Contributions by type</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            {% if contribution_types %}
                <div class="space-y-3">
                    {% for contrib_type in contribution_types %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                    <span class="material-icons-outlined text-purple-600 text-sm">payments</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ contrib_type.contribution_type__name|default:"Unknown" }}</p>
                                    <p class="text-sm text-gray-500">{{ contrib_type.count }} contributions</p>
                                </div>
                            </div>
                            <p class="font-bold text-green-600">{{ contrib_type.total|currency }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <span class="material-icons-outlined text-gray-400 text-4xl">payments</span>
                    <p class="text-gray-500 mt-2">No contribution data available</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Expenditure Breakdown -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                    <span class="material-icons-outlined text-orange-600">receipt_long</span>
                </div>
                <div>
                    <h2 class="font-semibold text-gray-900">Expenditure Breakdown</h2>
                    <p class="text-sm text-gray-500">Expenditures by category</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            {% if expenditure_categories %}
                <div class="space-y-3">
                    {% for exp_category in expenditure_categories %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                    <span class="material-icons-outlined text-orange-600 text-sm">shopping_cart</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ exp_category.category__name|default:"Unknown" }}</p>
                                    <p class="text-sm text-gray-500">{{ exp_category.count }} expenditures</p>
                                </div>
                            </div>
                            <p class="font-bold text-red-600">{{ exp_category.total|currency }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <span class="material-icons-outlined text-gray-400 text-4xl">receipt_long</span>
                    <p class="text-gray-500 mt-2">No expenditure data available</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Branch Summaries -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                    <span class="material-icons-outlined text-teal-600">business</span>
                </div>
                <div>
                    <h2 class="font-semibold text-gray-900">Branch Performance</h2>
                    <p class="text-sm text-gray-500">Financial summary by branch</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            {% if branch_summaries %}
                <div class="space-y-4">
                    {% for branch_summary in branch_summaries %}
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold text-gray-900">{{ branch_summary.branch.name }}</h3>
                                <p class="text-sm font-bold {% if branch_summary.net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ branch_summary.net_balance|currency }}
                                </p>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600">Contributions:</p>
                                    <p class="font-medium text-green-600">{{ branch_summary.contributions_total|currency }}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Expenditures:</p>
                                    <p class="font-medium text-red-600">{{ branch_summary.expenditures_total|currency }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <span class="material-icons-outlined text-gray-400 text-4xl">business</span>
                    <p class="text-gray-500 mt-2">No branch data available</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-indigo-600">people</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Active Members</h2>
                        <p class="text-sm text-gray-500">Members with activity</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold text-indigo-600">{{ active_members }}</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-pink-600">event_available</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Attendance Sessions</h2>
                        <p class="text-sm text-gray-500">Total services held</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold text-pink-600">{{ attendance_sessions_count }}</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-cyan-100 flex items-center justify-center">
                        <span class="material-icons-outlined text-cyan-600">groups</span>
                    </div>
                    <div>
                        <h2 class="font-semibold text-gray-900">Total Attendance</h2>
                        <p class="text-sm text-gray-500">Combined attendance</p>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <p class="text-3xl font-bold text-cyan-600">{{ total_attendance }}</p>
            </div>
        </div>
    </div>

    <!-- Archive Data Info -->
    {% if has_cached_data %}
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <span class="material-icons-outlined text-amber-600 mt-0.5">cached</span>
                <div>
                    <h3 class="font-semibold text-amber-900 mb-1">Cached Archive Data Available</h3>
                    <p class="text-amber-700 text-sm">
                        Historical archive tables contain cached summaries for this period. 
                        The live data shown above is computed directly from core tables and may be more current.
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}
