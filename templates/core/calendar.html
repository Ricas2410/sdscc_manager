{% extends 'base.html' %}
{% load core_tags %}
{% block title %}Church Calendar - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Compact Header with Navigation -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <!-- Title & Theme -->
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                    <span class="material-icons-outlined text-white text-2xl">calendar_month</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Church Calendar</h1>
                    {% if yearly_cal and yearly_cal.theme %}
                    <p class="text-sm text-blue-600 font-medium">{{ year }}: {{ yearly_cal.theme }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Navigation Controls -->
            <div class="flex items-center gap-2 flex-wrap">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    <span class="material-icons-outlined text-gray-600">chevron_left</span>
                </a>
                <div class="flex items-center gap-2">
                    <select onchange="location.href='?year={{ year }}&month='+this.value" class="input-field py-2 text-sm">
                        {% for m in "123456789101112"|make_list %}
                        {% with month_num=forloop.counter %}
                        <option value="{{ month_num }}" {% if month_num == month %}selected{% endif %}>
                            {% if month_num == 1 %}Jan{% elif month_num == 2 %}Feb{% elif month_num == 3 %}Mar{% elif month_num == 4 %}Apr{% elif month_num == 5 %}May{% elif month_num == 6 %}Jun{% elif month_num == 7 %}Jul{% elif month_num == 8 %}Aug{% elif month_num == 9 %}Sep{% elif month_num == 10 %}Oct{% elif month_num == 11 %}Nov{% elif month_num == 12 %}Dec{% endif %}
                        </option>
                        {% endwith %}
                        {% endfor %}
                    </select>
                    <select onchange="location.href='?year='+this.value+'&month={{ month }}'" class="input-field py-2 text-sm">
                        {% for y in years %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    <span class="material-icons-outlined text-gray-600">chevron_right</span>
                </a>
                <a href="?year={% now 'Y' %}&month={% now 'n' %}" class="px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                    Today
                </a>
                {% if user.is_mission_admin %}
                <a href="{% url 'core:calendar_manage' %}?year={{ year }}" class="btn-primary btn-sm">
                    <span class="material-icons-outlined text-sm mr-1">edit</span>Manage
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Calendar Grid - Takes 2 columns -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Month Title -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-3">
                    <h2 class="text-lg font-bold text-white text-center">{{ month_name }} {{ year }}</h2>
                </div>
                
                <!-- Day Headers -->
                <div class="grid grid-cols-7 bg-gray-50 border-b">
                    <div class="p-2 text-center text-xs font-semibold text-red-500">Sun</div>
                    <div class="p-2 text-center text-xs font-semibold text-gray-600">Mon</div>
                    <div class="p-2 text-center text-xs font-semibold text-gray-600">Tue</div>
                    <div class="p-2 text-center text-xs font-semibold text-gray-600">Wed</div>
                    <div class="p-2 text-center text-xs font-semibold text-gray-600">Thu</div>
                    <div class="p-2 text-center text-xs font-semibold text-gray-600">Fri</div>
                    <div class="p-2 text-center text-xs font-semibold text-blue-600">Sat</div>
                </div>
                
                <!-- Calendar Days -->
                {% for week in month_days %}
                <div class="grid grid-cols-7 border-b last:border-b-0">
                    {% for day in week %}
                    <div class="min-h-16 p-1 border-r last:border-r-0 {% if day == 0 %}bg-gray-50{% elif day == today.day and month == today.month and year == today.year %}bg-blue-50{% endif %} hover:bg-gray-50 transition-colors">
                        {% if day != 0 %}
                        <div class="flex flex-col h-full">
                            <span class="{% if day == today.day and month == today.month and year == today.year %}bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold{% elif forloop.counter0 == 0 %}text-red-500 text-xs font-medium{% else %}text-gray-700 text-xs font-medium{% endif %}">
                                {{ day }}
                            </span>
                            {% if day in events_by_day %}
                            <div class="mt-1 space-y-0.5 overflow-hidden">
                                {% for event in events_by_day|get_item:day %}
                                <div class="text-xs px-1 py-0.5 rounded truncate cursor-pointer hover:opacity-80 transition-opacity" 
                                     style="background-color: {{ event.color }}15; color: {{ event.color }}; font-size: 10px;"
                                     onclick="showEventDetails('{{ event.title }}', '{{ event.description|escapejs }}', '{{ event.start_date }}', '{{ event.location }}', '{{ event.get_event_type_display }}', '{{ event.color }}')">
                                    {{ event.title|truncatechars:12 }}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            
            <!-- Theme Verse -->
            {% if yearly_cal and yearly_cal.theme_verse %}
            <div class="mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <span class="material-icons-outlined text-blue-500">format_quote</span>
                    <p class="text-blue-800 italic text-sm">"{{ yearly_cal.theme_verse }}"</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar - Upcoming Events -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-4">
                <div class="bg-gradient-to-r from-green-600 to-green-700 px-4 py-3">
                    <h3 class="font-semibold text-white flex items-center gap-2">
                        <span class="material-icons-outlined text-sm">event</span>
                        Upcoming Events
                    </h3>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    {% for day, day_events in events_by_day.items %}
                    {% for event in day_events %}
                    <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                         onclick="showEventDetails('{{ event.title }}', '{{ event.description|escapejs }}', '{{ event.start_date }}', '{{ event.location }}', '{{ event.get_event_type_display }}', '{{ event.color }}')">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-10 h-10 rounded-lg flex flex-col items-center justify-center text-center" style="background-color: {{ event.color }}15;">
                                <span class="text-xs font-bold" style="color: {{ event.color }};">{{ event.start_date|date:"d" }}</span>
                                <span class="text-xs" style="color: {{ event.color }};">{{ event.start_date|date:"M" }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-gray-900 text-sm truncate">{{ event.title }}</h4>
                                <p class="text-xs text-gray-500">
                                    {% if event.start_time %}{{ event.start_time|time:"g:i A" }}{% endif %}
                                    {% if event.location %} â€¢ {{ event.location|truncatechars:15 }}{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% empty %}
                    <div class="p-6 text-center">
                        <span class="material-icons-outlined text-4xl text-gray-300">event_busy</span>
                        <p class="text-gray-500 text-sm mt-2">No events this month</p>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Quick Stats -->
                <div class="p-3 bg-gray-50 border-t border-gray-200">
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>{{ events_by_day|length }} events this month</span>
                        <a href="{% url 'announcements:events' %}" class="text-blue-600 hover:underline">View All</a>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="mt-4 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <h4 class="font-medium text-gray-900 text-sm mb-3">Event Types</h4>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <span class="text-xs text-gray-600">Service</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-xs text-gray-600">Meeting</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                        <span class="text-xs text-gray-600">Special</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <span class="text-xs text-gray-600">Holiday</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeEventModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
            <div class="p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div id="eventIcon" class="w-12 h-12 rounded-xl flex items-center justify-center">
                            <span class="material-icons-outlined text-white">event</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900" id="eventTitle"></h2>
                            <span class="text-xs px-2 py-1 rounded-full" id="eventTypeBadge"></span>
                        </div>
                    </div>
                    <button onclick="closeEventModal()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="material-icons text-gray-400">close</span>
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-600">
                        <span class="material-icons-outlined text-lg">schedule</span>
                        <span id="eventDate" class="text-sm"></span>
                    </div>
                    <div class="flex items-center gap-3 text-gray-600" id="eventLocationWrap">
                        <span class="material-icons-outlined text-lg">location_on</span>
                        <span id="eventLocation" class="text-sm"></span>
                    </div>
                    <div class="pt-3 border-t border-gray-200">
                        <p class="text-gray-700 text-sm" id="eventDescription"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showEventDetails(title, description, date, location, type, color) {
    document.getElementById('eventTitle').textContent = title;
    document.getElementById('eventDate').textContent = date;
    document.getElementById('eventLocation').textContent = location || 'Location TBD';
    document.getElementById('eventLocationWrap').style.display = location ? 'flex' : 'none';
    document.getElementById('eventTypeBadge').textContent = type;
    document.getElementById('eventTypeBadge').style.backgroundColor = color + '20';
    document.getElementById('eventTypeBadge').style.color = color;
    document.getElementById('eventIcon').style.backgroundColor = color;
    document.getElementById('eventDescription').textContent = description || 'No description provided.';
    document.getElementById('eventModal').classList.remove('hidden');
}

function closeEventModal() {
    document.getElementById('eventModal').classList.add('hidden');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeEventModal();
});
</script>
{% endblock %}
