{% extends 'base.html' %}
{% load static %}

{% block title %}Monthly Closing - {{ branch.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Monthly Closing</h1>
                <p class="text-gray-600 mt-1">Close month and generate financial reports</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                {% if request.user.is_mission_admin %}
                <select id="branchSelect" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for b in branches %}
                    <option value="{{ b.id }}" {% if b.id == branch.id %}selected{% endif %}>{{ b.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <select id="monthSelect" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for m in months %}
                    <option value="{{ m.0 }}" {% if m.0 == selected_month %}selected{% endif %}>{{ m.1 }}</option>
                    {% endfor %}
                </select>
                <select id="yearSelect" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for y in available_years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <button onclick="loadDashboard()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Load
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Total Contributions</p>
                    <p class="text-2xl font-bold text-gray-900">{{ summary.total_contributions|currency }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="material-icons text-green-600">trending_up</i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Mission Allocation</p>
                    <p class="text-2xl font-bold text-gray-900">{{ summary.total_mission|currency }}</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="material-icons text-blue-600">account_balance</i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Expenditures</p>
                    <p class="text-2xl font-bold text-gray-900">{{ summary.total_expenditure|currency }}</p>
                </div>
                <div class="bg-red-100 p-3 rounded-lg">
                    <i class="material-icons text-red-600">money_off</i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Net Balance</p>
                    <p class="text-2xl font-bold {% if summary.net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ summary.net_balance|currency }}</p>
                </div>
                <div class="{% if summary.net_balance >= 0 %}bg-green-100{% else %}bg-red-100{% endif %} p-3 rounded-lg">
                    <i class="material-icons {% if summary.net_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">balance</i>
                </div>
            </div>
        </div>
    </div>

    <!-- Close Month Section -->
    {% if not is_closed %}
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Close Month</h2>
        {% if can_close %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <p class="text-yellow-800">
                <i class="material-icons text-yellow-600 mr-2">info</i>
                Closing the month will lock all contributions and expenditures for {{ month_name }} {{ selected_year }}.
                Only Mission Admin can reopen closed months.
            </p>
        </div>
        <button onclick="closeMonth()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
            <i class="material-icons mr-2">lock</i>
            Close {{ month_name }} {{ selected_year }}
        </button>
        {% else %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800">
                <i class="material-icons text-red-600 mr-2">error</i>
                {{ close_message }}
            </p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-green-900">Month Closed</h2>
                <p class="text-green-700">{{ month_name }} {{ selected_year }} has been closed by {{ monthly_close.closed_by.get_full_name }}</p>
                <p class="text-sm text-green-600 mt-1">Closed on: {{ monthly_close.closed_at|date:"Y-m-d H:i" }}</p>
            </div>
            {% if request.user.is_mission_admin %}
            <button onclick="reopenMonth()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                <i class="material-icons mr-2">lock_open</i>
                Reopen Month
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Detailed Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Contributions by Type -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Contributions by Type</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Count</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Mission</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Branch</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for type, data in summary.contributions_by_type.items %}
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-900">{{ type }}</td>
                            <td class="px-4 py-2 text-sm text-right text-gray-900">{{ data.count }}</td>
                            <td class="px-4 py-2 text-sm text-right font-medium text-gray-900">{{ data.total|currency }}</td>
                            <td class="px-4 py-2 text-sm text-right text-gray-900">{{ data.mission|currency }}</td>
                            <td class="px-4 py-2 text-sm text-right text-gray-900">{{ data.branch|currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenditures by Category -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Expenditures by Category</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Count</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for category, data in summary.expenditures_by_category.items %}
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-900">{{ category }}</td>
                            <td class="px-4 py-2 text-sm text-right text-gray-900">{{ data.count }}</td>
                            <td class="px-4 py-2 text-sm text-right font-medium text-gray-900">{{ data.total|currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Remittance Status -->
    {% if summary.remittance %}
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Remittance Status</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-600">Amount Due</p>
                <p class="text-xl font-bold text-gray-900">{{ summary.remittance.amount_due|currency }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Amount Sent</p>
                <p class="text-xl font-bold text-gray-900">{{ summary.remittance.amount_sent|currency }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Status</p>
                <p class="text-xl font-bold {% if summary.remittance.status == 'paid' %}text-green-600{% elif summary.remittance.status == 'sent' %}text-blue-600{% else %}text-orange-600{% endif %}">
                    {{ summary.remittance.get_status_display|title }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex flex-col md:flex-row gap-4">
            <button onclick="generateMonthlyReport()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                <i class="material-icons mr-2">description</i>
                Generate Monthly Report
            </button>
            <button onclick="downloadPDF()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="material-icons mr-2">picture_as_pdf</i>
                Download PDF
            </button>
            <button onclick="viewHistory()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                <i class="material-icons mr-2">history</i>
                View Closed Months
            </button>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed bottom-4 right-4 z-50"></div>
{% endblock %}

{% block extra_js %}
<script>
function loadDashboard() {
    const branchId = document.getElementById('branchSelect').value;
    const month = document.getElementById('monthSelect').value;
    const year = document.getElementById('yearSelect').value;
    
    window.location.href = `/monthly-closing/?branch=${branchId}&month=${month}&year=${year}`;
}

function closeMonth() {
    if (!confirm('Are you sure you want to close this month? This action cannot be undone by branch administrators.')) {
        return;
    }

    const formData = new FormData();
    formData.append('branch_id', '{{ branch.id }}');
    formData.append('month', '{{ selected_month }}');
    formData.append('year', '{{ selected_year }}');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('/monthly-closing/close/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error: ' + error.message, 'error');
    });
}

function reopenMonth() {
    if (!confirm('Are you sure you want to reopen this month? This will allow editing of contributions and expenditures.')) {
        return;
    }
    
    const data = {
        'branch_id': '{{ branch.id }}',
        'month': '{{ selected_month }}',
        'year': '{{ selected_year }}'
    };
    
    fetch('/monthly-closing/reopen/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error: ' + error.message, 'error');
    });
}

function generateMonthlyReport() {
    window.location.href = `/monthly-report/?branch={{ branch.id }}&month={{ selected_month }}&year={{ selected_year }}`;
}

function downloadPDF() {
    window.open(`/monthly-report/pdf/?branch={{ branch.id }}&month={{ selected_month }}&year={{ selected_year }}`, '_blank');
}

function viewHistory() {
    // Show modal with closed months
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Closed Months</h3>
            <div class="space-y-2">
                {% for cm in closed_months %}
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span>{{ cm.branch.name }} - {{ cm.get_month_display }} {{ cm.year }}</span>
                    <span class="text-sm text-gray-600">{{ cm.closed_at|date:"Y-m-d" }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">No months have been closed yet.</p>
                {% endfor %}
            </div>
            <button onclick="this.closest('.fixed').remove()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                Close
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const alert = document.createElement('div');
    alert.className = `px-6 py-4 rounded-lg shadow-lg mb-4 flex items-center ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    alert.innerHTML = `
        <i class="material-icons mr-2">${type === 'success' ? 'check_circle' : 'error'}</i>
        <span>${message}</span>
    `;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}
