{% extends 'base.html' %}
{% load static %}

{% block title %}Export Members{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Export Members</h1>
                <p class="text-gray-600 mt-1">Export member data to Excel or CSV</p>
            </div>
        </div>
    </div>

    <!-- Export Form -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <form id="exportForm" class="space-y-6">
            <!-- Filter Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Options</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Area Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Area</label>
                        <select id="areaFilter" name="area" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Areas</option>
                            {% for area in areas %}
                            <option value="{{ area.id }}">{{ area.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- District Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">District</label>
                        <select id="districtFilter" name="district" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="">All Districts</option>
                        </select>
                    </div>

                    <!-- Branch Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Branch</label>
                        <select id="branchFilter" name="branch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="">All Branches</option>
                        </select>
                    </div>

                    <!-- Role Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Roles</option>
                            <option value="member">Member</option>
                            <option value="leader">Leader</option>
                            <option value="pastor">Pastor</option>
                            <option value="elder">Elder</option>
                            <option value="deacon">Deacon</option>
                            <option value="treasurer">Treasurer</option>
                            <option value="secretary">Secretary</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Status Filter -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Member Status</h3>
                <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="status" value="active" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Active</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="status" value="inactive" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Inactive</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="status" value="transferred" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Transferred</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="status" value="deceased" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Deceased</span>
                    </label>
                </div>
            </div>

            <!-- Data Fields Selection -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Include Fields</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="photo" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Photo URL</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="contact" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Contact Info</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="address" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Address</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="personal" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Personal Info</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="church" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Church Info</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="family" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Family Info</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="occupation" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Occupation</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="fields" value="skills" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Skills</span>
                    </label>
                </div>
            </div>

            <!-- Export Options -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Options</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Format</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="format" value="excel" checked class="border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Excel (.xlsx)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="format" value="csv" class="border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">CSV (.csv)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                        <select name="sort_by" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="name">Name (A-Z)</option>
                            <option value="date_joined">Date Joined</option>
                            <option value="branch">Branch</option>
                            <option value="role">Role</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4">
                <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Reset
                </button>
                <button type="button" onclick="previewData()" class="px-6 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                    Preview
                </button>
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="material-icons mr-2">download</i>
                    Export Data
                </button>
            </div>
        </form>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="bg-white rounded-lg shadow-sm p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Preview Results</h3>
        <div class="mb-4">
            <p class="text-sm text-gray-600">
                Found <span id="previewCount" class="font-bold">0</span> members matching your criteria
            </p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr id="previewHeader">
                        <!-- Headers will be added dynamically -->
                    </tr>
                </thead>
                <tbody id="previewBody" class="bg-white divide-y divide-gray-200">
                    <!-- Preview rows will be added dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed bottom-4 right-4 z-50"></div>
{% endblock %}

{% block extra_js %}
<script>
// Load districts when area changes
document.getElementById('areaFilter').addEventListener('change', function() {
    const areaId = this.value;
    const districtSelect = document.getElementById('districtFilter');
    const branchSelect = document.getElementById('branchFilter');

    // Reset district and branch filters
    districtSelect.innerHTML = '<option value="">All Districts</option>';
    districtSelect.disabled = !areaId;
    branchSelect.innerHTML = '<option value="">All Branches</option>';
    branchSelect.disabled = true;

    if (areaId) {
        fetch(`/members/api/districts/${areaId}/`)
            .then(response => response.json())
            .then(data => {
                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.id;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading districts:', error);
                showMessage('Error loading districts. Please try again.', 'error');
            });
    }
});

// Load branches when district changes
document.getElementById('districtFilter').addEventListener('change', function() {
    const districtId = this.value;
    const branchSelect = document.getElementById('branchFilter');

    console.log('District changed, ID:', districtId);

    // Reset branch filter
    branchSelect.innerHTML = '<option value="">All Branches</option>';
    branchSelect.disabled = !districtId;

    if (districtId) {
        const url = `/members/api/branches/${districtId}/`;
        console.log('Fetching branches from:', url);

        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Branches data received:', data);
                if (data.branches && data.branches.length > 0) {
                    data.branches.forEach(branch => {
                        console.log('Adding branch:', branch.name);
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = branch.name;
                        branchSelect.appendChild(option);
                    });
                } else {
                    console.log('No branches found for this district');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No branches available';
                    option.disabled = true;
                    branchSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading branches:', error);
                showMessage('Error loading branches. Please try again.', 'error');
            });
    }
});

// Form submission
document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const params = new URLSearchParams();
    
    // Convert FormData to URLSearchParams
    for (let [key, value] of formData.entries()) {
        if (params.has(key)) {
            params.append(key, value);
        } else {
            params.set(key, value);
        }
    }
    
    // Get selected format
    const format = formData.get('format');
    
    // Open export URL in new window
    const url = `/members/export-${format}/?${params.toString()}`;
    window.open(url, '_blank');
    
    showMessage('Export started. Download will begin shortly.', 'success');
});

function resetForm() {
    document.getElementById('exportForm').reset();
    document.getElementById('previewSection').classList.add('hidden');
    document.getElementById('districtFilter').disabled = true;
    document.getElementById('branchFilter').disabled = true;
}

function previewData() {
    const formData = new FormData(document.getElementById('exportForm'));
    const params = new URLSearchParams();
    
    // Convert FormData to URLSearchParams
    for (let [key, value] of formData.entries()) {
        if (params.has(key)) {
            params.append(key, value);
        } else {
            params.set(key, value);
        }
    }
    
    // Add preview flag
    params.set('preview', 'true');
    
    fetch(`/members/export-preview/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPreview(data);
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Error: ' + error.message, 'error');
        });
}

function showPreview(data) {
    const previewSection = document.getElementById('previewSection');
    const previewCount = document.getElementById('previewCount');
    const previewHeader = document.getElementById('previewHeader');
    const previewBody = document.getElementById('previewBody');
    
    // Update count
    previewCount.textContent = data.count;
    
    // Clear existing content
    previewHeader.innerHTML = '';
    previewBody.innerHTML = '';
    
    // Add headers
    data.headers.forEach(header => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = header;
        previewHeader.appendChild(th);
    });
    
    // Add preview rows (max 10)
    data.rows.slice(0, 10).forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        row.forEach(cell => {
            const td = document.createElement('td');
            td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
            td.textContent = cell || '--';
            tr.appendChild(td);
        });
        
        previewBody.appendChild(tr);
    });
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Scroll to preview
    previewSection.scrollIntoView({ behavior: 'smooth' });
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const alert = document.createElement('div');
    alert.className = `px-6 py-4 rounded-lg shadow-lg mb-4 flex items-center ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    alert.innerHTML = `
        <i class="material-icons mr-2">${type === 'success' ? 'check_circle' : 'error'}</i>
        <span>${message}</span>
    `;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}
